<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Listener Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; max-width: 760px; margin: 24px auto; padding: 0 12px; }
    #chat { border: 1px solid #ddd; border-radius: 10px; padding: 12px; height: 60vh; overflow:auto; }
    .msg { margin: 10px 0; }
    .role { font-weight: 700; }
    form { display:flex; gap: 8px; margin-top: 12px; }
    input { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ddd; }
    button { padding: 12px 16px; border-radius: 10px; border: 1px solid #ddd; cursor: pointer; }
    .hint { color:#666; font-size: 14px; }
  </style>
</head>
<body>
  <h2>Listener Test</h2>
  <p class="hint">This link must include <code>?auth=...</code>.</p>

  <div id="chat"></div>

  <form id="form">
    <input id="input" placeholder="Type..." autocomplete="off" />
    <button type="submit">Send</button>
  </form>

<script>
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const formEl = document.getElementById("form");

  let history = [];

  function add(role, content) {
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `<span class="role">${role}:</span> ${content}`;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function authQuery() {
    return window.location.search || "";
  }

  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    const msg = inputEl.value.trim();
    if (!msg) return;
    inputEl.value = "";

    add("You", msg);

    const r = await fetch("/api/chat" + authQuery(), {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ message: msg, history })
    });

    if (!r.ok) {
      add("Error", await r.text());
      return;
    }

    const data = await r.json();
    add("AI", data.reply);

    history.push({role:"user", content: msg});
    history.push({role:"assistant", content: data.reply});
  });

  add("AI", "Hi — I’m here with you. What’s on your mind?");
</script>
</body>
</html>
